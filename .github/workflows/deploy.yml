name: CI/CD Pipeline - Flask App

on:
  push:
    branches:
      - main
    paths:
      - '**'
      - '!README.md'
      - '!AZURE_SETUP.md'
      - '!.gitignore'
  pull_request:
    branches:
      - main
    paths:
      - '**'
      - '!README.md'
      - '!AZURE_SETUP.md'
      - '!.gitignore'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: deploy-cicd-hadua2dxe6g2fcbc
  PYTHON_VERSION: '3.12'

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Lint with flake8
      run: |
        pip install flake8
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run tests
      run: |
        # Basic smoke test - check if app can start
        python -c "from app import app; print('‚úÖ App imports successfully')"
        echo "‚úÖ Basic validation passed"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: flask-app
        path: |
          app.py
          requirements.txt
          runtime.txt
          web.config
          ./

  test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Test Flask app startup
      run: |
        # Test if the Flask app can start properly
        timeout 10s python app.py &
        sleep 3
        if curl -f http://localhost:5000/api/health; then
          echo "‚úÖ Flask app started successfully"
          pkill -f "python app.py"
        else
          echo "‚ùå Flask app failed to start"
          pkill -f "python app.py"
          exit 1
        fi

    - name: Test API endpoints
      run: |
        # Start the app in background
        python app.py &
        APP_PID=$!
        sleep 3

        # Test health endpoint
        if curl -f http://localhost:5000/api/health; then
          echo "‚úÖ Health endpoint works"
        else
          echo "‚ùå Health endpoint failed"
          kill $APP_PID
          exit 1
        fi

        # Test users endpoint
        if curl -f http://localhost:5000/api/users; then
          echo "‚úÖ Users endpoint works"
        else
          echo "‚ùå Users endpoint failed"
          kill $APP_PID
          exit 1
        fi

        # Cleanup
        kill $APP_PID
        echo "‚úÖ All integration tests passed"

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: flask-app

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies for deployment
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Pre-deployment validation
      run: |
        echo "üîç Validating deployment package..."
        # Check if main files exist
        [ -f "app.py" ] && echo "‚úÖ app.py exists" || (echo "‚ùå app.py missing" && exit 1)
        [ -f "requirements.txt" ] && echo "‚úÖ requirements.txt exists" || (echo "‚ùå requirements.txt missing" && exit 1)
        [ -f "runtime.txt" ] && echo "‚úÖ runtime.txt exists" || (echo "‚ùå runtime.txt missing" && exit 1)
        [ -f "web.config" ] && echo "‚úÖ web.config exists" || (echo "‚ùå web.config missing" && exit 1)

        # Validate Python syntax
        python -m py_compile app.py && echo "‚úÖ Python syntax is valid" || (echo "‚ùå Python syntax error" && exit 1)

        echo "‚úÖ Pre-deployment validation passed"

    - name: Deploy to Azure Web App
      uses: azure/webapps-deploy@v3
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        slot-name: 'production'
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .

    - name: Post-deployment verification
      run: |
        echo "üîç Verifying deployment..."
        # Wait for deployment to complete
        sleep 30

        # Test the deployed application
        MAX_RETRIES=5
        RETRY_COUNT=0

        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f -s "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/api/health" > /dev/null; then
            echo "‚úÖ Deployment successful! App is responding."
            echo "üåê URL: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net"
            exit 0
          else
            echo "‚è≥ Waiting for deployment... (attempt $((RETRY_COUNT+1))/$MAX_RETRIES)"
            sleep 15
            RETRY_COUNT=$((RETRY_COUNT+1))
          fi
        done

        echo "‚ùå Deployment verification failed after $MAX_RETRIES attempts"
        exit 1
